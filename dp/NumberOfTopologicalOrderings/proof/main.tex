\documentclass[a4paper,12pt]{article}

\usepackage{cmap}
\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english,russian]{babel}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{indentfirst}
\usepackage{fullpage}
\usepackage{tikz}

\pagenumbering{gobble}

\begin{document}
\theoremstyle{plain}
\newtheorem*{theorem}{Теорема}

\section*{Постановка задачи}
Дано ориентированное дерево из $N$ вершин, найти количество его топологических сортировок.

\section*{Решение}
Дерево имеет рекурсивную структуру, рассмотрим решение задачи для некоторого дерева с корнем $v$ и поддеревьями $T_1, T_2, \dots, T_n$. Обозначим за $ts_i$ количество топологических сортировок поддерева $T_i$, а за $k_i$ "--- число вершин в поддереве $T_i$.

Для начала рассмотрим случай, когда $n=2$.

\begin{figure}[!htb]
\centering
\begin{tikzpicture}
  \node {$v$}
    child {node {$T_1$}}
    child {node {$T_2$}};
\end{tikzpicture}
\caption{Рассматриваемое дерево при $n=2$}
\end{figure}

Любая топологическая сортировка данного дерева будет иметь вид
\[ v, v_1, v_2, \dots, v_{k_1 + k_2} \]
где $v_1, v_2, \dots, v_{k_1 + k_2} \in T_1 \cup T_2$. Тогда число таких сортировок вычисляется как
\[ ts_1 \cdot ts_2 \cdot N \]
где $N$ "--- число способов объединить последовательности вершин двух поддеревьев, полученные их топологической сортировкой, не нарушая исходный порядок в каждой из них.

$N$ вычисляется как $C_{k_1 + k_2}^{k_1}$, потому что для объединения последовательностей необходимо выбрать $k_1$ из $k_1 + k_2$ позиций, на которые будут размещены элементы первого поддерева в исходном порядке, а на свободные поместить элементы второго поддерева также с сохранением порядка.

Упростим $C_{k_1 + k_2}^{k_1}$:
\[
C_{k_1 + k_2}^{k_1}
  = \frac{(k_1 + k_2)!}{k_1!(k_1 + k_2 - k_1)!}
  = \frac{(k_1 + k_2)!}{k_1!k_2!}
\]

Получаем
\[ ts_1 \cdot ts_2 \cdot \frac{(k_1 + k_2)!}{k_1!k_2!} \]

Обобщим до произвольного числа поддеревьев.

\begin{figure}[!htb]
\centering
\begin{tikzpicture}
  \node {$v$}
    child {node {$T_1$}}
    child {node {$\cdots$} edge from parent[draw=none]}
    child {node {$T_n$}};
\end{tikzpicture}
\caption{Рассматриваемое дерево при $n \geqslant 2$}
\end{figure}

\begin{itemize}
\item $n = 1$: $ts_1$
\item $n = 2$: рассмотрен выше.
\item $n > 2$: расширим подсчет $N$ до произвольного числа поддеревьев.
  Сначала вычислим $N$ для первых двух поддеревьев, потом для объединения первых двух и третьего поддеревьев, и так далее.
  Пусть $ F(n, m) = \frac{(n+m)!}{n!m!} $.
  Получим \[ \prod^n_{i=1} ts_i \cdot \prod^{n}_{i=2} F(k_1 + \cdots + k_{i-1}, k_i) \]
\end{itemize}

Нетрудно вывести из описанной формулы рекуррентное соотношение.

\section*{Реализация}

Мемоизация тривиальна: начнем подсчет с листьев, в ходе алгоритма послойно поднимаясь до корня.

\begin{theorem}
Описанный алгоритм позволяет вычислить количество топологических сортировок дерева из $N$ вершин за $O(N^3)$.
\end{theorem}
\begin{proof}
Обозначим за $n_i$ число детей вершины $i$, за $k_i$ "--- размер поддерева с корнем в вершине $i$.

Восстановим описанную при построении алгоритма формулу для дерева с корнем в вершине $i$ с $m = n_i$ детьми $j_1, \dots, j_m$:
\[ \prod^{m}_{s=1} ts_s \cdot \prod^{m}_{s=2} F(k_{j_1} + \cdots + k_{j_{s-1}}, k_{j_s}) \]

Вычисление факториала $n$ требует $O(n)$ операций, поэтому вычисление второго из произведений ограничивается сверху $O(m k_i)$. Это следует из того, что сумма размеров поддеревьев не превосходит размера самого дерева. Таким образом и вся формула вычисляется за $O(mk_i)$, так как вычисление первого произведения требует лишь $O(m)$ операций.

Очевидно, что количество операций для каждой вершины не превысит $O(N^2)$. Так как вершин в дереве ровно $N$, получаем итоговую асимптотику $O(N^3)$.
\end{proof}

\end{document}
